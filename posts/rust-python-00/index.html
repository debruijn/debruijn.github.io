<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Rust in Python part 0: why and how?</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#a3a5a9;--bg-color:#fff;--highlight-mark-color:#5f75b035;--blockquote-color:#8e8d91;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body.dark{--primary-color:#5d77ac;--primary-pale-color:#5d77ac20;--text-color:#9197a5;--text-pale-color:#656a74;--bg-color:#18191b;--highlight-mark-color:#5f75b035;--blockquote-color:#747983;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body{--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:56px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0px;--detail-border-radius:0px;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0px;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>const theme=sessionStorage.getItem(`theme`);const match=window.matchMedia(`(prefers-color-scheme: dark)`).matches;if(theme&&theme==`dark`||!theme&&match){document.body.classList.add(`dark`);const a=document.querySelector(`link#hl`);if(a)a.href=`/hl-dark.css`}</script><header><div id=header-wrapper><nav><a class=instant href=/>debruijn</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a class=instant href=/posts>posts</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/portfolio>portfolio</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/about>about</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/posts/feed.xml id=rss-btn><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" id=theme-toggle><span class=moon-icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></span> <span class=sun-icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill=currentColor></path></svg></span></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><dialog id=rss-mask><div><a href=https://debruijn.github.io/posts/feed.xml>https://debruijn.github.io/posts/feed.xml</a><button data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' aria-label=copy autofocus data-link=https://debruijn.github.io/posts/feed.xml><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill=currentColor></path></svg></button></div></dialog><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#why-is-rust-faster-than-python>Why is Rust faster than Python?</a><li><a class=h2 href=#does-this-only-hold-for-rust>Does this only hold for Rust?</a><li><a class=h2 href=#what-is-coming-up>What is coming up?</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Rust in Python part 0: why and how?</h1><div id=post-info><div id=date><span id=publish>2024-10-18</span></div><div id=tags><a class=instant href=https://debruijn.github.io/tags/rust><span>#</span>rust</a><a class=instant href=https://debruijn.github.io/tags/python><span>#</span>python</a></div></div><blockquote class="callout alert hidden" data-alert-text-after=" days ago and may be out of date." data-alert-text-before="This article was last updated " data-days=120 id=outdate_alert><div class=content></div></blockquote><p>When coding in Python, you will occasionally be in a situation where a single function or a few functions are responsible for the majority of your execution time. In most cases, that is fine: if for a particular task, 95% of your time is spent in a single function but the total run time is less than a second, and this particular task is not ran frequently, then there is no reason to worry about speed improvements.<p>But of course, the opposite will happen as well: this 1 second task needs to be ran 1000 or 1000000 times each time you do a particular broader task (say, a model run in your data science research; or a ingestion of data in your pipeline; or every time a page loads on your website). Bringing down this 1 second to a tenth of second will be worth it in aggregate. If for this or another reason you want to speed it up, there are roughly two categories of things you can do:<ul><li>Be smart in a classical way<li>Be smart in a different way</ul><p>One way of being smart is looking at your process, and figure out if there are ways to avoid some of these calculations:<ul><li>Are you recalculating a variable in a loop that could be precalculated once?<li>Can you use a cache to store the output for particular input states? And if so, can you be smarter about defining what a state is, say when a permutation of the same inputs doesn't matter for the output value?<li>Is there a faster implementation of what you try to do out there that you can use? Does that meet your requirements?<li>Can you make some assumptions to skip over some of the calculations, and get to, say, 99% of the result in 1% of the time?</ul><p>This way of being smart requires you to think, which sometimes you don't want to do. You might also have to convince other people that this is actually worth it. And: there is no guarantee that refactoring in such a way will lead to a speed improvement: sometimes an alternative approach turns out to be slower.<p>So, what is that other way of being smart? Of course, given the title of this series of blog posts, the answer involves implementing your Python functionality in Rust, and using that in Python. Ideally, from a Python user perspective, they wouldn't even know they use Rust under the hood. In fact, an alternative way to spell this other way of being smart would be l-a-z-y: instead of thinking if a better algorithm exists and what that would be, you just reimplement the current one. The next pages in this series will show my experience in learning how to do that (without knowing Rust beforehand!) and also the limitations to this approach.<p>A few remarks to discuss beforehand, to get some of the caveats out of the way..<h3 id=why-is-rust-faster-than-python>Why is Rust faster than Python?<a aria-label="Anchor link for: why-is-rust-faster-than-python" class=zola-anchor href=#why-is-rust-faster-than-python style=visibility:hidden></a></h3><p>The main relevant difference between Rust and Python in this regard is that Rust is a compiled and statically-typed language and Python is not. This makes it that some of the complexities in what needs to happen can be solved or optimized by the Rust syntax and compiler during writing or compiling your code, while the Python interpreter has to do that live while running the code. Think of adding two integers x and y together. In the case of Rust, the compiler will have made sure that the exact procedure that has to be followed has been defined, so when you run your code, it can just do that procedure. In the case of Python, a lot of questions (might*) have to be answered: are both x and y really numbers, and are they really integers? What do we do in case the answer is no? This results in more decision points needing to be figured out at every step, and decision points slow every process down (this is also true for processes outside programming).<h3 id=does-this-only-hold-for-rust>Does this only hold for Rust?<a aria-label="Anchor link for: does-this-only-hold-for-rust" class=zola-anchor href=#does-this-only-hold-for-rust style=visibility:hidden></a></h3><p>No, there are many other choices you could make instead of Rust as well. An obvious one is C, which is the language used for a lot of core Python functions themselves (Python is not written in Python, or, not only in Python). There are some advantages and disadvantages of Rust over C. The main disadvantage of Rust is that for C, due to its historic presence, there are more resources out there than for Rust: more example code, more IDE integration, and also more fellow programmers that can help you out.<p>The main advantage (although it depends on who you ask) is that Rust is annoying. And annoying is good if you are new to statically-typed languages. There are also moments where the harsh rules of Rust could slow you down compared to using something like C, but these are less likely if you are just aiming to replace a single core Python function with a piece of external code in Rust or C. Instead, if you aim to use such a language only for these critical speed-up situations, you are likely to have forgotten about the details of this lower-level language, and then it helps you that Rust and its compiler will remind you of everything that you are doing wrong.<p>In a different use case, your choice of language might be different, but my experience was that within half a day I was able to learn some basic Rust, and learn how to call Rust from Python to speed-up a pre-existing function to less than 10% of its run time. Even more, because of the Rust compiler (and me shutting down its complaints) I was already quite confident that this solution actually works for a variety of input values and not just the ones that I tried.<h3 id=what-is-coming-up>What is coming up?<a aria-label="Anchor link for: what-is-coming-up" class=zola-anchor href=#what-is-coming-up style=visibility:hidden></a></h3><p>This page tries to answer the "Why Rust?" question. What follows will be answers to the "How to Rust" question:<ul><li>How to get started with Rust, and Rust in Python<li>How to apply this to a pre-existing function<li>How to include Rust code in your Python package<li>How to incorporate this into your Python toolset going forward</ul><p>These pages will be more code-based and less text-based, but they will also involve my own experiences and suggestions. You can use them together with existing documentation (which can be a bit scattered all over the place).<p>Of course, you can use this series as a starting point of learning more Rust (which is also what I did!). Or as a starting point for learning other languages and integrate them in Python (which is also what I have planned!). But you have to start somewhere, and it's nice to get to some tangible gain that you can incorporate into an existing codebase or workflow. So for that first step, go to the <a href=/posts/rust-python-01>first page</a> of this series.</article><div class=giscus></div></div><footer><div class=copyright><p>Â© 2024 Bert de Bruijn</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>