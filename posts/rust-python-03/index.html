<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Rust in Python part 3: publish a Python package</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#a3a5a9;--bg-color:#fff;--highlight-mark-color:#5f75b035;--blockquote-color:#8e8d91;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body.dark{--primary-color:#5d77ac;--primary-pale-color:#5d77ac20;--text-color:#9197a5;--text-pale-color:#656a74;--bg-color:#18191b;--highlight-mark-color:#5f75b035;--blockquote-color:#747983;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body{--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:56px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0px;--detail-border-radius:0px;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0px;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>const theme=sessionStorage.getItem(`theme`);const match=window.matchMedia(`(prefers-color-scheme: dark)`).matches;if(theme&&theme==`dark`||!theme&&match){document.body.classList.add(`dark`);const a=document.querySelector(`link#hl`);if(a)a.href=`/hl-dark.css`}</script><header><div id=header-wrapper><nav><a class=instant href=/>debruijn</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a class=instant href=/posts>posts</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/portfolio>portfolio</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/about>about</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/posts/feed.xml id=rss-btn><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" id=theme-toggle><span class=moon-icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></span> <span class=sun-icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill=currentColor></path></svg></span></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><dialog id=rss-mask><div><a href=https://debruijn.github.io/posts/feed.xml>https://debruijn.github.io/posts/feed.xml</a><button data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' aria-label=copy autofocus data-link=https://debruijn.github.io/posts/feed.xml><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill=currentColor></path></svg></button></div></dialog><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#what-is-intervalues>What is intervalues?</a><li><a class=h2 href=#the-rust-implementation>The Rust implementation</a><li><a class=h2 href=#speed-comparison>Speed comparison</a> <ul><li><a class=h3 href=#intfloat-vs-decimal>Intfloat vs Decimal</a><li><a class=h3 href=#combine-intervals-python-vs-rust>combine_intervals: Python vs Rust</a></ul><li><a class=h2 href=#building-a-python-package-with-rust-code>Building a Python package with Rust code</a> <ul><li><a class=h3 href=#updating-pyproject-toml>Updating pyproject.toml</a><li><a class=h3 href=#add-a-rust-folder-with-the-wrapper-functionality>Add a rust folder with the wrapper functionality</a><li><a class=h3 href=#add-a-manifest-in-file>Add a MANIFEST.in file</a></ul><li><a class=h2 href=#publishing-a-python-package-with-rust-code>Publishing a Python package with Rust code</a><li><a class=h2 href=#alternative-setups>Alternative setups</a><li><a class=h2 href=#links>Links</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Rust in Python part 3: publish a Python package</h1><div id=post-info><div id=date><span id=publish>2024-11-03</span></div><div id=tags><a class=instant href=https://debruijn.github.io/tags/rust><span>#</span>rust</a><a class=instant href=https://debruijn.github.io/tags/python><span>#</span>python</a></div></div><blockquote class="callout alert hidden" data-alert-text-after=" days ago and may be out of date." data-alert-text-before="This article was last updated " data-days=120 id=outdate_alert><div class=content></div></blockquote><p>In the previous entries in this series, the concept of moving functionality from Python to Rust was illustrated using examples out of real-life application. On this page, I want to talk about my experience of doing a similar addition to my <code>intervalues</code> package, which can be found <a rel="nofollow noreferrer" href=https://github.com/debruijn/intervalues>here</a>. I will not fully discuss the Rust implementation details, but just the overall learnings and suggestions.<h2 id=what-is-intervalues>What is intervalues?<a aria-label="Anchor link for: what-is-intervalues" class=zola-anchor href=#what-is-intervalues style=visibility:hidden></a></h2><p><code>intervalues</code> is a Python package aimed at processing valued intervals efficiently. With valued intervals, I mean something like "All values between 2 and 4, with a value of 3". Say you note this down as <code>[2-4; 3]</code>, and you have any valued interval <code>[1-3; 2]</code>. Then you might want to add these together, which would produce the three valued intervals <code>[1-2; 2]</code>, <code>[2-3; 5]</code> and <code>[3-4; 3]</code> that would summarize for each input the total value. Tasks like this have popped up in some previous Advent of Code challenges, and I can imagine practical applications as well, with the value part often being interpreted as "counts". For example, how many planes are there on an airfield at any given time for a recurring daily or weekly schedule? In that case, each input interval would be a 1-count interval with bounds set to the landing and departure time of the plane. For planes that land at the end of the schedule and depart at the beginning, there would be two intervals for both parts. Then, all these intervals could be combined to find the overlaps and counts across the schedule in an exact and efficient way, which can be used to identify potential bottlenecks or expansion opportunities.<p>Although other interval-themed Python packages exist, the 'count' or 'value' perspective of it was not represented. Instead, these other packages are often limited to looking at it from a Set perspective, so finding either the union or the intersection of the input intervals. Translated to the airfield example above: "At what times is there at least one plane on the airfield?" and "At what times are all scheduled planes on the airfield simultaneously?". These questions can be useful as well ("When should the airfield be open?" for the first case for example) but could be answered by <code>intervalues</code> as well by looking at all intervals with a count >= 1 for the first case, and all intervals with the count equal to the number of planes for the second case.<p>The package provides functionality for all kinds of data management-like tasks you might want to do with one or more intervals: adding together, shifting, finding the most-common interval in an interval collection, finding the value of a particular input, etc. At the core of this, there is an algorithm for combining the intervals together, appropriately called <code>combine_intervals</code>. This algorithm is the key thing that could slow the package down in case of a huge dataset, and because of that it is the key candidate to consider for porting over to Rust for a potential speed boost.<h2 id=the-rust-implementation>The Rust implementation<a aria-label="Anchor link for: the-rust-implementation" class=zola-anchor href=#the-rust-implementation style=visibility:hidden></a></h2><p>Implementing <code>combine_intervals</code> in Rust was a task that I tackled from the core up. An interesting challenge in this was that the types of the numbers have to be defined beforehand as Rust is a typed language. First, I avoided that by implementing the function just for <code>isize</code> input for both the bounds and the value, and then I made variations of it where either could be <code>f32</code> as well, as proof of concepts. It was good to start with this, because a potential blocker quickly became apparent: the <code>combine_intervals</code> algorithm requires the bounds to be used as index in a <code>HashMap</code> (the Rust version of a <code>dict</code> in Python) but the standard floats in Rust are not hashable. So first, this challenge had to be solved, for which I ended up with two solutions:<ul><li>using <code>Decimals</code> from <code>rust_decimals</code>, which is an alternative numeric implementation for (among other) floats<li>creating my own <code>intfloat</code> <a rel="nofollow noreferrer" href=https://crates.io/crates/intfloat/>package</a> and Struct, which is faster than Decimals but also less reliable for accuracy <ul><li>the issue with the latter is in how numbers are stored: as 2 integers, a base integer and a power-of-10 integer. In the conversion of, say, 2 x 10^-4 back to a float there is a risk of a small error to be introduced, for example to get 0.00020000001 instead of 0.0002. Since the '4' above is an input on the Python side, you can simply round it again in Python to the same number of digits - but this might be a problem in a more generic use of <code>intfloat</code> so in that case using <code>Decimals</code> might be smart.</ul></ul><p>Then, as next steps I slowly generalized the functions by making use of the Numeric trait (if you don't know about Rust traits yet: don't worry about it): first combining all integer inputs into one function call, and all float inputs into another; and then generalizing that to end up with a single function that is reused across all potential input types. It supports the above mentioned <code>Decimal</code> and <code>IntFloat</code> together with all default integer types.<p>At first, the combined result was just a <code>Vec</code> containing the relevant numeric values for each aggregated valued subinterval. It simply made sense to also collect this in a well-defined Struct, and so also the Rust version of having an IntervalCollection. Because of this, the Rust code is also available and usable by itself without Python on <a rel="nofollow noreferrer" href=https://crates.io/crates/intervalues/>crates.io</a>, although the main goal of the project remains the Python code.<h2 id=speed-comparison>Speed comparison<a aria-label="Anchor link for: speed-comparison" class=zola-anchor href=#speed-comparison style=visibility:hidden></a></h2><p>The main motivation of both the Rust version of <code>intervalues</code> and of the <code>intfloat</code> package is speed, so we need to actually verify that both provide a speed boost compared to the Python version of <code>intervalues</code> and the <code>Decimals</code> struct respectively.<h3 id=intfloat-vs-decimal>Intfloat vs Decimal<a aria-label="Anchor link for: intfloat-vs-decimal" class=zola-anchor href=#intfloat-vs-decimal style=visibility:hidden></a></h3><p>For this comparison, I use the demo implementation of the <code>intervalues</code> Rust package in its <code>main.rs</code>. This runs 4 setups in which one million intervals are generated and combined, with its inputs being:<ol><li><code>i32</code> for both integer bounds and value -> runs in 38.1 ms<li><code>i32</code> for integer bounds and <code>Decimal</code> for float value -> runs in 60.6 ms<li><code>Decimal</code> for both float bounds and value -> runs in 143.6 ms<li><code>IntFloat</code> for both float bounds and value -> runs in 68.4 ms</ol><p>This shows that using <code>IntFloat</code> is roughly twice as slow as using <code>i32</code> but twice as fast as using <code>Decimal</code>, at least for this setup. On the one hand, this shows the added value of the existence of <code>IntFloat</code>. On the other hand, in the rare situation you would need to combine one million intervals, having to wait 0.1s is not too bad, so <code>Decimal</code> is still a good option even if it's the slowest.<h3 id=combine-intervals-python-vs-rust>combine_intervals: Python vs Rust<a aria-label="Anchor link for: combine-intervals-python-vs-rust" class=zola-anchor href=#combine-intervals-python-vs-rust style=visibility:hidden></a></h3><p>For the secondary speed check, I had to make my Rust package available for Python again using maturin, and then make a wrapper to use either the Python or the Rust implementation depending on some input flag. To test for speed, I added an example script that runs both of them, for both integer and float inputs.<p>The results are (for one million intervals) as follows:<ul><li>integers: 1774 ms (Python) vs 900 ms (Rust)<li>floats: 1976 ms (Python) vs 857 ms (Rust)</ul><p>This pattern holds for smaller number of intervals as well: Rust is about as fast for integers and floats whereas Python is about twice as slow for integers, and a bit extra slow for floats. Also note that this call of Rust via Python is significantly slower than the 38.1ms or 68.4ms for the same setup in pure Rust above. Again the same two factors appear like in the previous entry in this blog series: there is the extra overhead of code that is needed to get this translation to work, and next to that there are a million intervals (so 3 million values) that needs to be transferred from Python to Rust.<p>Together, this shows that for the Python package, the Rust implementation of the core functionality can result in a good speedup, but that it is also worthwhile to maintain the pure Rust version of the package for cases where extra speed is absolutely critical. Having it confirmed that all these efforts are worth it, now we move on to the next step: including the Rust code in my published PyPI package as well.<h2 id=building-a-python-package-with-rust-code>Building a Python package with Rust code<a aria-label="Anchor link for: building-a-python-package-with-rust-code" class=zola-anchor href=#building-a-python-package-with-rust-code style=visibility:hidden></a></h2><p>In order to build <code>intervalues</code> with the Rust code in it as well in the way I did it, there were a few things I had to do:<ul><li>Update my <code>pyproject.toml</code> to include <code>setuptools-rust</code><li>Add a rust folder to my Python repo with a Rust-to-Python wrapper in it<li>Add a MANIFEST.in to make the build process aware of the above files</ul><p>Let's go over them one by one!<h3 id=updating-pyproject-toml>Updating pyproject.toml<a aria-label="Anchor link for: updating-pyproject-toml" class=zola-anchor href=#updating-pyproject-toml style=visibility:hidden></a></h3><p>To adjust the build process to make use of the Rust packages as well, we need to update the file that is the input to the build process: <code>pyproject.toml</code> (of an alternative to that if you use it). In this toml, we need to update the <code>build-system</code> section:<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">build-system</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">requires</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>setuptools>=61.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-array z-toml">,</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>setuptools-rust<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">build-backend</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>setuptools.build_meta<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span></code></pre><p>Also, we need to add a new section specifically for <code>setuptools-rust</code>:<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-array z-begin z-toml">[[</span><span class="z-meta z-tag z-table z-array z-toml"><span class="z-entity z-name z-table z-toml">tool</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">setuptools-rust</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">ext-modules</span></span><span class="z-punctuation z-definition z-table z-array z-end z-toml">]]</span>
</span><span class="z-source z-toml"><span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> Private Rust extension module to be nested into the Python package</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">target</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>intervalues_pyrust<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>   <span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> Name of the package/module as defined in Cargo.toml</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">path</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>rust/Cargo.toml<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>        <span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> The location of the Cargo.toml</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">binding</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>PyO3<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>                <span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> Default value, can be omitted</span>
</span></code></pre><p>You can see here already a peak of the name and location of the rust files in the next subsection. Next to this, you can specify which binding to use, which is here defined as the default <code>PyO3</code> (which is that same technology as what maturin uses).<p>Finally, an issue I encountered was that I specified my version in a <code>version.py</code>. For my setup, this will not work, since the python modules can't be imported before the rust-wrapper has been made available to Python. If you are in the same situation, you have two basic choices: overhaul your code to delay the import of the rust wrapper, or instead put your version information in a non-Python file. I have chosen the latter using the good old <code>VERSION</code> setup:<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">tool</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">setuptools</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">dynamic</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">file</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>VERSION<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span>
</span></code></pre><h3 id=add-a-rust-folder-with-the-wrapper-functionality>Add a rust folder with the wrapper functionality<a aria-label="Anchor link for: add-a-rust-folder-with-the-wrapper-functionality" class=zola-anchor href=#add-a-rust-folder-with-the-wrapper-functionality style=visibility:hidden></a></h3><p>I created a very simple <code>rust</code> folder in the root of my Python repository containing (in essence) not much more than a <code>Cargo.toml</code> and a <code>src/lib.rs</code> file with all its functionality. In the <code>lib.rs</code> file the two <code>combine_intervals</code> functions for int and float input are defined, which both call the same <code>combine_intervals</code> from the actual Rust <code>intervalues</code> package but with different before steps (the ints are <code>isize</code>, whereas the floats are converted to <code>IntFloat</code>).<p>This is confirmed by the associated <code>Cargo.toml</code> as well, which is setup using the same changes as needed for a Maturin build: the <code>dependencies.pyo3</code> section with the specified ABI, the <code>crate_type</code> being set to <code>cdylib</code>, and the <code>opt-level</code> set to 3. Next to that, it has dependencies set to the main <code>intervalues</code> and <code>intfloat</code> since it uses them both (and also <code>itertools</code>). The name is specified as <code>intervalues_pyrust</code> in both the package and lib section of the toml.<p>Note that these two files are all that is technically needed (plus the automatically generated <code>Cargo.lock</code>), but I also included a LICENSE and README.md file for publishing this <code>intervalues_pyrust</code> to crates.io as well, and a separate <code>pyproject.toml</code> with all the Maturin-specific definitions in case I want to try out something quickly without fully building the Python wheel.<p>Why all of this work for this separate wrapper with a new name? A couple of reasons:<ul><li>I wanted to split the Rust and Python work as much as possible in separate repositories.<li>I also wanted to split the functionality of the pure Rust version and the wrapper, such that I can individually maintain and update those<li>With the default <code>intervalues</code> name for the rust package, there was some potential for conflict with the folder with my Python code having the same name (and during the Maturin test phase, this really was an issue). Of course, I can also just rename that folder without impacting the name of the package, but I prefer not to overhaul the Python part due to some non-Python reason.</ul><p>I didn't have to publish this <code>intervalues_pyrust</code> on crates.io as well, but I felt like doing that anyway, at the very least to claim that name.<h3 id=add-a-manifest-in-file>Add a MANIFEST.in file<a aria-label="Anchor link for: add-a-manifest-in-file" class=zola-anchor href=#add-a-manifest-in-file style=visibility:hidden></a></h3><p>Finally, the shortest addition is a MANIFEST.in file at the project root. This file will make sure the build process can find and use the files in the rust folder. It is in my case defined as:<pre class=z-code><code><span class="z-text z-plain">include rust/Cargo.toml
</span><span class="z-text z-plain">recursive-include rust/ *.rs
</span></code></pre><p>The result of all this is a buildable Python wheel that contains the Rust code. Before uploading to PyPI I did the basic checks: can I install it locally on my system? Can I install it in a Docker image? In both cases, can I also use it to run the Rust specific functions? All systems were go, so let's publish to PyPI using twine like I normally do. And then it happens: the error that I can't upload my wheel because it is compiled specifically for my system. (Like the issue described <a rel="nofollow noreferrer" href=https://stackoverflow.com/questions/59451069/binary-wheel-cant-be-uploaded-on-pypi-using-twine>here</a> on StackOverflow).<h2 id=publishing-a-python-package-with-rust-code>Publishing a Python package with Rust code<a aria-label="Anchor link for: publishing-a-python-package-with-rust-code" class=zola-anchor href=#publishing-a-python-package-with-rust-code style=visibility:hidden></a></h2><p>So, the main lesson from the problem above: by compiling my Rust code, I can't share it in the same way I can share my Python packages. Since "normal" <code>intervalues</code> is written in Pure Python, it can be made available in the broadest way possible, with the only restriction due to me using some syntax introduced in Python 3.10. But now, in the way I have build my Python&Rust combined <code>intervalues</code>, it can only be used on a Linux system setup similar to mine, and that is not acceptable for PyPI.<p>So, how to solve this? Like mentioned on the StackOverflow link above, for this we can use the <code>manylinux</code> project and the <code>auditwheel</code> tool.<p>This project has as goal to make tools available that will make it you can build a Python package with compiled code and still make it available across "many linux setups" (hence the name). They do this by offering Docker images that have been configured with compiler toolchains from some time ago, making sure that all recent Linux distributions support the output of it. They offer multiple versions depending on how far back you want to go.<p>One of the other software in these Docker images is the <code>auditwheel</code> tool to be used to make sure the wheels that are built indeed conform to all requirements needed for uploading to PyPI.<p>In order to use this, download the <code>build-wheels.sh</code> file on <a rel="nofollow noreferrer" href=https://setuptools-rust.readthedocs.io/en/latest/building_wheels.html>this link</a> and adjust it to your project needs. For <code>intervalues</code> you can see this in the <a rel="nofollow noreferrer" href=https://github.com/debruijn/intervalues>repository</a>. My adjustments are to target Python 3.10 and up, together with Pypy 3.10. Next to that, of course, I had to adjust the example project name to <code>intervalues</code>.<p>Then, to use this with the Docker image, pull the one you want to use (e.g. <code>docker pull quay.io/pypa/manylinux2014_x86_64</code>) and from the project root run the script above using this Docker image with the following command:<pre class=z-code><code><span class="z-text z-plain">docker run --rm -v `pwd`:/io quay.io/pypa/manylinux2014_x86_64 bash /io/build-wheels.sh
</span></code></pre><p>Note that this will take more time than a normal Python package build, because it will do the build and checks for all specified versions of CPython and PyPy. The result is also a set of wheels for each of these, instead of a single one for Python in general. These need to all be uploaded to PyPI to make available for installation.<p>But then after all this.. it works! I can <code>pip install</code> the new version of <code>intervalues</code> and make use of the Rust functionality in both Python 3.10 and PyPy 3.10. The only downside is that it is now (afaik) Linux specific: this newest version (as of writing) can't be installed on Windows whereas the version before can. I can't verify this since I don't have a Windows box available right now, but this is what I have been able to gather from what I read about it. To be honest, I personally don't really care about that. But if there is an <code>intervalues</code> user who wants me to find out if/how it can still be used on Windows even with this Rust functionality, let me know (or, of course, submit a PR yourself). Alternatively, the old version still works on Windows and there are no real changes from that version to this one outside of the Rust wrapper.<h2 id=alternative-setups>Alternative setups<a aria-label="Anchor link for: alternative-setups" class=zola-anchor href=#alternative-setups style=visibility:hidden></a></h2><p>There are several alternatives to consider to some of the steps that I have taken, which I might experiment with in the future. Experiences from readers are also welcome, especially if these alternatives work really good or really bad.<ul><li>Maturin allows you to directly publish the Python package with Rust functionality using <code>maturin publish</code> instead of <code>maturin develop</code>. I have not tried this, so I don't know whether the result is OS-agnostic or if it uses some kind of <code>manylinux</code> restriction as well, or something else. Also, this feels like it would make most sense if the wrapper was included in the base Rust <code>intervalues</code> package, since it will introduce another package itself (a Python package that the main Python <code>intervalues</code> package can include as a dependency).<li>I want to look into how to make the Rust component optional, and if that makes the core Python functionality still usable on Windows. <ul><li>I could (either by using Maturin as above, or manually) publish the Python side of the Python/Rust layer separately from the rest of the Python code, and make it an optional dependency of the main <code>intervalues</code>.<li>Perhaps there also other ways of doing this</ul><li>Ideally, I want to have the Rust setup also usable on Windows. Like discussed in the previous section, I will likely not look into this myself until a Windows user requests this, especially if I can figure out how to create non-Rust future versions as well that are more universally usable. <ul><li>Probably the first candidate to explore for this functionality is to use the <code>cibuildwheel</code> as mentioned in the <a rel="nofollow noreferrer" href=https://setuptools-rust.readthedocs.io/en/latest/building_wheels.html>setuptools-rust</a> docs as well.</ul><li>Let me know if you have other suggestions as well for how to best set this up!</ul><p>Depending on these investigations and/or suggestions, there might be a future entry in this series to discuss them. But for now, the next (and potentially final) entry in this series will be on my <a href=/posts/rust-python-04>overall learnings and experience</a> of using Rust in Python. Alternatively, have a look at some of the links down below for further reading.<h2 id=links>Links<a aria-label="Anchor link for: links" class=zola-anchor href=#links style=visibility:hidden></a></h2><ul><li>Some of the other Python interval packages: <ul><li>portion<li>pyinterval</ul><li>My repo's and packages related to intervals: <ul><li>Python intervalues: <a rel="nofollow noreferrer" href=https://github.com/debruijn/intervalues>github</a> and <a rel="nofollow noreferrer" href=https://pypi.org/project/intervalues/>PyPI</a><li>Rust intervalues: <a rel="nofollow noreferrer" href=https://github.com/debruijn/intervalues_rust>github</a> and <a rel="nofollow noreferrer" href=https://crates.io/crates/intervalues/>crates.io</a><li>intervalues_pyrust: <a rel="nofollow noreferrer" href=https://crates.io/crates/intervalues_pyrust>crates.io</a><li>intfloat: <a rel="nofollow noreferrer" href=https://github.com/debruijn/intfloat>github</a> and <a rel="nofollow noreferrer" href=https://crates.io/crates/intfloat/>crates.io</a></ul><li>More resources on setuptools-rust: <ul><li><a rel="nofollow noreferrer" href=https://setuptools-rust.readthedocs.io/en/latest/README.html>Overall doc on setuptools-rust</a><li><a rel="nofollow noreferrer" href=https://setuptools-rust.readthedocs.io/en/latest/setuppy_tutorial.html>If you want to use setup.py instead of pyproject.toml</a><li><a rel="nofollow noreferrer" href=https://setuptools-rust.readthedocs.io/en/latest/building_wheels.html>Building wheels</a></ul><li>More resources on manylinux and auditwheel: <ul><li><a rel="nofollow noreferrer" href=https://github.com/pypa/manylinux>The manylinux repository</a> with details on what the different <code>manylinux</code> versions imply for Python and distribution support.<li><a rel="nofollow noreferrer" href=https://github.com/pypa/auditwheel>The auditwheel tool</a> showing examples of other commands that can be supplied to it, for example for only checking (not repairing) existing wheels for PyPI compatibility.</ul></ul></article><div class=giscus></div></div><footer><div class=copyright><p>© 2024 Bert de Bruijn</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>